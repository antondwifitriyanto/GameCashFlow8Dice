<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cash Flow Management ‚Äì White/Blue + Actions</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#0b2a5e;--muted:#6b86b5;--blue:#2563eb;--blue-soft:#e7efff;--line:#d6e2ff;
    --green:#22c55e;--danger:#ef4444;--amber:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:var(--ink)}

  .wrap{display:grid;grid-template-columns:340px 1fr;height:100vh;overflow:hidden}
  .sidebar{padding:14px;background:#fff;border-right:1px solid var(--line);overflow:auto}
  h1{font-size:18px;margin:0 0 6px;font-weight:800}
  .caps{letter-spacing:.35px;text-transform:uppercase;color:var(--muted);font-size:11px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px;margin:10px 0;box-shadow:0 6px 18px rgba(37,99,235,.06)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .row{display:flex;gap:8px;align-items:center}
  .btn{cursor:pointer;border:1px solid var(--blue);background:#fff;color:var(--blue);padding:10px 12px;border-radius:12px;font-weight:700}
  .btn.primary{background:linear-gradient(180deg,#4f8df7,#2563eb);border-color:transparent;color:#fff}
  .btn.danger{background:linear-gradient(180deg,#ff8a8a,#ef4444);color:#fff;border:0}
  .btn.warn{background:linear-gradient(180deg,#ffd166,#f59e0b);color:#4a2d00;border:0}
  .money{font-weight:800;color:#0f8b4c}
  .log{height:160px;overflow:auto;background:#f7faff;border:1px solid var(--line);border-radius:12px;padding:8px;font-size:12px;color:#163a7a}

  .stage{position:relative;display:flex;align-items:center;justify-content:center;height:100vh;overflow:hidden;background:#fff}
  .board{position:relative;width:min(92vmin,1200px);height:min(92vmin,1200px)}
  .imgbg{position:absolute;inset:0}
  .imgbg img{width:100%;height:100%;object-fit:contain;user-select:none;pointer-events:none}
  svg{position:absolute;inset:0;width:100%;height:100%}

  .hud{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center}

  /* HUD FIXED di luar gambar (kanan-atas) */
  .hudFixed{position:fixed;right:12px;top:12px;z-index:50;display:flex;flex-direction:column;gap:10px;align-items:flex-end}
  .floatCard{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;min-width:240px;max-width:360px;box-shadow:0 8px 20px rgba(18,60,150,.12)}
  .bigClock{font-weight:800;font-size:18px}
  .lbHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .lbRow{display:grid;grid-template-columns:auto 1fr auto;gap:6px;align-items:center;font-size:12px;padding:6px;border-radius:10px}
  .lbRow.leader{background:var(--blue-soft);border:1px solid var(--line)}
  .lbName{font-weight:700}
  .lbTotal{font-weight:800;color:#0b2a5e}
  .lbSub{grid-column:1 / -1;color:#446aa8;font-size:11px}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(10,40,120,.18);display:none;align-items:center;justify-content:center;z-index:60}
  .modal .content{background:#fff;border:1px solid var(--line);border-radius:14px;max-width:560px;width:94%;padding:14px;box-shadow:0 10px 28px rgba(18,60,150,.16)}
  .modal .title{font-weight:800;margin-bottom:8px}
  .modal.show{display:flex}
  .opt{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .opt .btn{padding:8px 10px}

  /* Toast kecil untuk konfirmasi aksi */
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0ea5e9;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.15);display:none;z-index:70}
  .toast.show{display:block}
  .toast.warn{background:#f59e0b}
  .toast.danger{background:#ef4444}
  .toast.ok{background:#22c55e}

  /* Pulse jejak */
  .pulse{animation:pulse .8s ease-in-out infinite}
  @keyframes pulse{0%{opacity:.15}50%{opacity:.55}100%{opacity:.15}}
</style>
</head>
<body>

<!-- HUD FIXED -->
<div class="hudFixed">
  <div class="floatCard" id="timerPanel">
    <div class="lbHead"><div class="caps">Durasi</div><div class="caps" id="startInfo"></div></div>
    <div id="gameClock" class="bigClock">00:00</div>
  </div>
  <div class="floatCard" id="leaderPanel">
    <div class="lbHead"><div class="caps">Leaderboard CF (Kas+S+I)</div><div class="caps" id="leaderSummary"></div></div>
    <div id="leaderList"></div>
  </div>
</div>

<div class="wrap">
  <aside class="sidebar">
    <h1>Cash Flow Management</h1>
    <div class="caps">Binus University- Management</div>

    <div class="card">
      <div class="grid2">
        <div><div class="caps">Pemain</div><div id="activeName" style="font-weight:800">-</div></div>
        <div><div class="caps">Putaran</div><div id="roundNo" style="font-weight:800">1</div></div>
        <div><div class="caps">Tahun</div><div id="yearNo" style="font-weight:800">1</div></div>
        <div><div class="caps">Langkah</div><div id="lastRoll" style="font-weight:800">-</div></div>
      </div>
    </div>

    <div class="card grid3">
      <button id="rollBtn" class="btn primary">üé≤ Kocok D8</button>
      <button id="endBtn" class="btn">‚è≠Ô∏è Akhiri</button>
      <button id="resetBtn" class="btn danger">üîÑ Reset</button>
    </div>

    <div class="card grid2">
      <div><div class="caps">Kas (CF)</div><div id="cash" class="money">0</div></div>
      <div><div class="caps">Pendapatan (Y)</div><div id="income" class="money">0</div></div>
      <div><div class="caps">Konsumsi (C)</div><div id="cons" class="money">0</div></div>
      <div><div class="caps">Tabungan (S)</div><div id="save" class="money">0</div></div>
      <div><div class="caps">Portofolio (I)</div><div id="inv" class="money">0</div></div>
      <div><div class="caps">Kekayaan Bersih</div><div id="netw" class="money">0</div></div>
    </div>

    <div class="card">
      <div class="caps">Log</div>
      <div id="log" class="log"></div>
    </div>
  </aside>

  <section class="stage">
    <div class="board" id="boardRoot">
      <div class="imgbg"><img src="CashFlow.png" alt="Papan Cash Flow Management"></div>
      <svg id="svg" viewBox="-500 -500 1000 1000" aria-label="overlay"></svg>

      <div class="hud">
        <div id="tileInfo" class="caps">Siap bermain</div>
      </div>
    </div>
  </section>
</div>

<!-- Modal umum -->
<div id="modal" class="modal"><div class="content">
  <div id="cardTitle" class="title">Aksi</div>
  <div id="cardText" style="margin:6px 0 10px"></div>
  <div id="cardActions" class="opt"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
    <button class="btn" id="okBtn">Tutup</button>
  </div>
</div></div>

<!-- Modal setup pemain -->
<div id="playerModal" class="modal"><div class="content">
  <div class="title">Pengaturan Pemain</div>
  <div class="row">Jumlah: <select id="playerCount"><option>1</option><option selected>2</option><option>3</option><option>4</option></select></div>
  <div id="names" style="margin-top:8px"></div>
  <div style="text-align:right;margin-top:8px"><button class="btn primary" id="startBtn">Mulai</button></div>
</div></div>

<div id="toast" class="toast">OK</div>

<script>
/* ================== CONFIG (sesuai buku) ================== */
const board = {
  size: 24,
  // Tipe petak; nilai C/TAX dapat diisi spesifik bila kamu punya peta nominal dari papan
  tiles: [
    'INCOME','CONSUME','SAVE','INVEST','CHANCE','CONSUME','INCOME',
    'RISK','INVEST','SAVE','TAX','BONUS','INCOME','CONSUME','INVEST',
    'CHANCE','SAVE','RISK','INCOME','CONSUME','INVEST','SAVE','TAX','BURSA'
  ],
  // Nilai default untuk petak (bisa kamu sesuaikan per index)
  values: { CONSUME: 5, TAX: 5, INCOME: 5 } // contoh nominal
};
const START_INDEX = Math.round(board.size*0.5); // tengah-bawah
board.tiles[START_INDEX] = 'START';

const CF = (n)=>n; // unit CF integer
const state = { round:1, year:1, active:0, rolling:false, players:[] };

/* Jalur & Token besar */
const rPath = 400; const TOKEN_BASE = 28; const tokenSize = TOKEN_BASE*2;
const svg = document.getElementById('svg'); let tokenLayers = []; let glowLayer;

/* Timer */
let gameStartTs = null, _timerInt = null;

/* ================== UTIL ================== */
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
function posFor(i, rr=rPath){ const ang=((i/board.size)*Math.PI*2) - Math.PI/2; return {x:Math.cos(ang)*rr, y:Math.sin(ang)*rr} }
function fmtCF(n){ return `CF ${n}` }
function log(t){ const el=document.getElementById('log'); el.innerHTML = `<div>${new Date().toLocaleTimeString('id-ID',{hour12:false})} ‚Äî ${t}</div>` + el.innerHTML }
function toast(msg, cls='ok'){ const t=document.getElementById('toast'); t.textContent=msg; t.className='toast show '+(cls||''); setTimeout(()=>{t.className='toast'},1400) }

/* ================== AUDIO ringkas ================== */
const AC=new (window.AudioContext||window.webkitAudioContext)();
function blip(f=600,len=.06){ const o=AC.createOscillator(),g=AC.createGain(); o.type='square';o.frequency.value=f;o.connect(g);g.connect(AC.destination);g.gain.value=.12;o.start();setTimeout(()=>{g.gain.exponentialRampToValueAtTime(.0001,AC.currentTime+.05);o.stop()},len*1000) }
function diceSfx(){ blip(700,.05); setTimeout(()=>blip(500,.05),60); setTimeout(()=>blip(900,.05),120) }
function stepSfx(){ blip(420,.04) }

/* ================== DRAW BOARD ================== */
function buildBoard(){
  svg.innerHTML='';
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  const flt=document.createElementNS('http://www.w3.org/2000/svg','filter');
  flt.setAttribute('id','g'); flt.innerHTML='<feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>';
  defs.appendChild(flt); svg.appendChild(defs);
  glowLayer=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(glowLayer);
  tokenLayers = state.players.map(()=>{ const g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('filter','url(#g)'); svg.appendChild(g); return g; });
  drawTokens();
}
function drawTokens(){
  tokenLayers.forEach((g,idx)=>{
    const p=state.players[idx]; if(!p) return;
    const rr = rPath - idx* (tokenSize*0.25);
    const {x,y}=posFor(p.pos, rr);
    g.innerHTML='';
    const neon = ['#0ea5e9','#f43f5e','#f59e0b','#22c55e','#8b5cf6','#ef4444'];

    const body=document.createElementNS('http://www.w3.org/2000/svg','rect');
    body.setAttribute('x', x - tokenSize/2);
    body.setAttribute('y', y - tokenSize*0.55);
    body.setAttribute('width', tokenSize);
    body.setAttribute('height', tokenSize*1.1);
    body.setAttribute('rx', tokenSize*0.22);
    body.setAttribute('fill', neon[idx % neon.length]);
    body.setAttribute('stroke', '#ffffff');
    body.setAttribute('stroke-width', tokenSize*0.06);
    g.appendChild(body);

    const head=document.createElementNS('http://www.w3.org/2000/svg','circle');
    head.setAttribute('cx', x);
    head.setAttribute('cy', y - tokenSize*0.9);
    head.setAttribute('r', tokenSize*0.35);
    head.setAttribute('fill', '#fff7e6');
    head.setAttribute('stroke','#1f2937');
    head.setAttribute('stroke-width', tokenSize*0.04);
    g.appendChild(head);
  });
}
function highlightPath(from,steps){
  glowLayer.innerHTML='';
  for(let k=1;k<=steps;k++){
    const i=(from+k)%board.size; const {x,y}=posFor(i);
    const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
    dot.setAttribute('class','pulse'); dot.setAttribute('cx',x); dot.setAttribute('cy',y);
    dot.setAttribute('r','14'); dot.setAttribute('fill','#2563eb'); dot.setAttribute('opacity','.28');
    glowLayer.appendChild(dot);
  }
}

/* ================== GAME LOGIC ================== */
const META={ START:'START/GO', BONUS:'BONUS', BURSA:'BURSA (jual saja)', INCOME:'INCOME', CONSUME:'CONSUMPTION', SAVE:'SAVING', INVEST:'INVEST', CHANCE:'OPPORTUNITY', RISK:'RISK', TAX:'TAX' };
function cur(){ return state.players[state.active] }
function totals(p){ return p.cash + p.saving + p.portfolio.total }
function updateHUD(){
  const p=cur(); if(!p) return;
  activeName.textContent=p.name; roundNo.textContent=state.round; yearNo.textContent=state.year;
  cash.textContent=p.cash; income.textContent=p.income; cons.textContent=p.baselineC; save.textContent=p.saving; inv.textContent=p.portfolio.total; netw.textContent=totals(p);
  tileInfo.textContent = META[board.tiles[p.pos]] || '-';
  renderLeaderboard();
}
function enforceNoDebt(p){
  if(p.cash>=0) return;
  let needed = -p.cash; const h=p.portfolio.holdings; const kinds = Object.keys(h).sort((a,b)=>h[b]-h[a]);
  for(const k of kinds){
    if(needed<=0) break;
    const sell = Math.min(h[k], needed*2); // dapat 50%
    if(sell>0){ h[k]-=sell; const proceed = Math.floor(sell*0.5); p.cash += proceed; needed = -p.cash; log(`${p.name}: Jual ${k} (50%) ‚Üí +${fmtCF(proceed)}`); }
  }
  recalcPortfolio(p);
}
function addCash(p,a){ p.cash += a; if(p.cash<0){ log(`${p.name}: Dana kurang ‚Üí jual aset otomatis.`); enforceNoDebt(p); } updateHUD(); }
function payday(p){ addCash(p, CF(20)); log(`${p.name}: START/GO ‚Üí ${fmtCF(20)}`) }
function bonus(p){ addCash(p, CF(10)); log(`${p.name}: BONUS ‚Üí ${fmtCF(10)}`) }
function consumeNow(p,amt){ addCash(p,-CF(amt)); log(`${p.name}: Konsumsi ${fmtCF(amt)}`); toast(`Bayar konsumsi ${fmtCF(amt)}`,'warn'); }
function recalcPortfolio(p){ let t=0; for(const k in p.portfolio.holdings) t+=p.portfolio.holdings[k]; p.portfolio.total=t; p.saving = p.savingBanks.A + p.savingBanks.B + p.savingBanks.C + p.savingBanks.D; }

/* ===== INVEST / BURSA quick actions ===== */
function buy(p,kind,amt){ amt=clamp(CF(amt),0,p.cash); if(amt<=0){toast('Dana tidak cukup','danger');return} p.cash-=amt; p.portfolio.holdings[kind]=(p.portfolio.holdings[kind]||0)+amt; recalcPortfolio(p); updateHUD(); log(`${p.name}: Beli ${kind} ${fmtCF(amt)}`); toast(`Beli ${kind} ${fmtCF(amt)}`) }
function sellAtExchange(p,kind,amt){ amt=clamp(CF(amt),0,(p.portfolio.holdings[kind]||0)); if(amt<=0){toast('Tidak ada aset','danger');return} p.portfolio.holdings[kind]-=amt; p.cash+=amt; recalcPortfolio(p); updateHUD(); log(`${p.name}: Jual ${kind} di BURSA ${fmtCF(amt)}`); toast(`Jual ${kind} ${fmtCF(amt)}`) }

/* ===== SAVING (A-D) + Kartu Saving ===== */
const BANKS=['A','B','C','D'];
function deposit(p,bank,amt){ amt=clamp(CF(amt),0,p.cash); if(amt<=0){toast('Dana tidak cukup','danger');return} p.cash-=amt; p.savingBanks[bank]+=amt; recalcPortfolio(p); updateHUD(); log(`${p.name}: Deposito Bank ${bank} ${fmtCF(amt)}`); toast(`Deposit ${fmtCF(amt)} @Bank ${bank}`) }
function withdraw(p,bank,amt){ amt=clamp(CF(amt),0,p.savingBanks[bank]); if(amt<=0){toast('Saldo deposito kosong','danger');return} p.savingBanks[bank]-=amt; p.cash+=amt; recalcPortfolio(p); updateHUD(); log(`${p.name}: Cairkan Bank ${bank} ${fmtCF(amt)}`); toast(`Cairkan ${fmtCF(amt)} @Bank ${bank}`) }
const savingDeck=[
  {type:'bank', bank:'A', text:'Imbal hasil deposito Bank A: +CF 5', effect:p=>{p.cash+=CF(5); updateHUD();}},
  {type:'bank', bank:'B', text:'Imbal hasil deposito Bank B: +CF 5', effect:p=>{p.cash+=CF(5); updateHUD();}},
  {type:'bank', bank:'C', text:'Imbal hasil deposito Bank C: +CF 5', effect:p=>{p.cash+=CF(5); updateHUD();}},
  {type:'bank', bank:'D', text:'Imbal hasil deposito Bank D: +CF 5', effect:p=>{p.cash+=CF(5); updateHUD();}},
  {type:'all', text:'Imbal hasil semua bank: +CF 2', effect:p=>{p.cash+=CF(2); updateHUD();}},
  {type:'gift', text:'Hadiah dari Bank Kustodian: +CF 10', effect:p=>{p.cash+=CF(10); updateHUD();}},
];
function drawSavingCard(p){
  const c = savingDeck[rand(0,savingDeck.length-1)];
  showModal('Kartu Saving', `<div style="color:#163a7a">${c.text}</div>`, [{label:'Ambil', cls:'primary', on:()=>{ c.effect(p); log(`${p.name}: ${c.text}`); hideModal(); toast('Kartu Saving diproses'); }}]);
}

/* ===== Modal helpers ===== */
const modal=document.getElementById('modal'); const cardTitle=document.getElementById('cardTitle'); const cardText=document.getElementById('cardText'); const cardActions=document.getElementById('cardActions'); const okBtn=document.getElementById('okBtn');
function showModal(title, html, actions=[]){
  cardTitle.textContent=title; cardText.innerHTML=html||''; cardActions.innerHTML='';
  actions.forEach(a=>{ const b=document.createElement('button'); b.className='btn '+(a.cls||''); b.textContent=a.label; b.onclick=a.on; cardActions.appendChild(b); });
  modal.classList.add('show');
}
function hideModal(){ modal.classList.remove('show') }
okBtn.onclick=hideModal;

/* ===== Tindakan ketika mendarat di petak ===== */
function onTile(p,type){
  tileInfo.textContent = META[type] || type;
  switch(type){
    case 'START': payday(p); break;
    case 'BONUS': bonus(p); break;
    case 'BURSA': showBursaModal(p); break;
    case 'INCOME': { const v=board.values.INCOME??5; addCash(p, CF(v)); showModal('Income', `Terima pendapatan ${fmtCF(v)}`,[{label:'OK',cls:'primary',on:hideModal}]); break; }
    case 'CONSUME': { const v=board.values.CONSUME??5; consumeNow(p, v); showModal('Consumption (C)', `Bayar konsumsi ${fmtCF(v)} sekarang.`,[{label:'OK',cls:'warn',on:hideModal}]); break; }
    case 'SAVE': showSavingModal(p); break;
    case 'INVEST': showInvestModal(p); break;
    case 'TAX': { const v=board.values.TAX??5; addCash(p,-CF(v)); showModal('TAX', `Bayar pajak ${fmtCF(v)}.`,[{label:'OK',cls:'warn',on:hideModal}]); log(`${p.name}: Pajak ${fmtCF(v)}`); break; }
    case 'CHANCE': { addCash(p,CF(5)); showModal('Opportunity', 'Pendapatan tambahan CF 5.',[{label:'OK',cls:'primary',on:hideModal}]); break; }
    case 'RISK': { addCash(p,-CF(5)); showModal('Risk', 'Pengeluaran tak terduga CF 5.',[{label:'OK',cls:'warn',on:hideModal}]); break; }
  }
}

/* ===== Modal khusus aksi ===== */
function showInvestModal(p){
  showModal('INVEST', 'Pilih aset & nominal untuk BELI.', [
    {label:'Emas +CF5', cls:'primary', on:()=>{buy(p,'emas',5); hideModal();}},
    {label:'Saham +CF5', cls:'primary', on:()=>{buy(p,'saham',5); hideModal();}},
    {label:'Properti +CF10', cls:'primary', on:()=>{buy(p,'properti',10); hideModal();}},
    {label:'Reksadana +CF10', cls:'primary', on:()=>{buy(p,'reksadana',10); hideModal();}},
  ]);
}
function showBursaModal(p){
  // hanya jual
  const acts=[];
  ['emas','saham','properti','reksadana'].forEach(k=>{
    const have=p.portfolio.holdings[k]||0;
    if(have>0){
      acts.push({label:`Jual ${k} -CF5`, cls:'danger', on:()=>{sellAtExchange(p,k,Math.min(5,have)); hideModal();}});
    }
  });
  if(!acts.length){ acts.push({label:'Tidak ada aset', on:hideModal}); }
  showModal('BURSA (Jual saja)', 'Jual sebagian aset yang dimiliki.', acts);
}
function showSavingModal(p){
  // pilihan sesuai buku: Deposit / Cairkan / Kartu Saving
  const acts=[
    {label:'Deposit', cls:'primary', on:()=>{
      const bHtml = BANKS.map(b=>`<button class="btn" onclick="window._dep('${b}',5)">Bank ${b} +CF5</button>
                                   <button class="btn" onclick="window._dep('${b}',10)">Bank ${b} +CF10</button>`).join(' ');
      showModal('SAVING ‚Äì Deposit', `<div class="caps">Pilih bank & nominal</div><div class="opt">${bHtml}</div>`,[{label:'Selesai',on:hideModal}]);
    }},
    {label:'Cairkan', cls:'warn', on:()=>{
      const bHtml = BANKS.map(b=>`<button class="btn" onclick="window._wd('${b}',5)">Bank ${b} -CF5</button>
                                   <button class="btn" onclick="window._wd('${b}',10)">Bank ${b} -CF10</button>`).join(' ');
      showModal('SAVING ‚Äì Cairkan', `<div class="caps">Tarik sebagian deposito</div><div class="opt">${bHtml}</div>`,[{label:'Selesai',on:hideModal}]);
    }},
    {label:'Kartu Saving', on:()=>{ drawSavingCard(p); }}
  ];
  showModal('SAVING (S)', '<div class="caps">Pilih salah satu aksi:</div>', acts);
}
// helper untuk tombol inline pada modal HTML
window._dep=(bank,amt)=>{ deposit(cur(),bank,amt); }
window._wd=(bank,amt)=>{ withdraw(cur(),bank,amt); }

/* ===== Pergerakan ===== */
function crossedStart(prev, next){
  if(prev===next) return false;
  if(prev < START_INDEX && next >= START_INDEX) return true;
  if(prev > next && (START_INDEX <= next || START_INDEX > prev)) return true;
  return false;
}
function animateMove(steps){
  if(state.rolling) return; state.rolling=true;
  const p=cur(); let moved=0; const from=p.pos;
  highlightPath(from,steps);
  const t=setInterval(()=>{
    const prev=p.pos;
    p.pos=(p.pos+1)%board.size; moved++; drawTokens(); stepSfx();
    if(p.pos===START_INDEX || crossedStart(prev,p.pos)){ payday(p); }
    if(moved>=steps){
      clearInterval(t); glowLayer.innerHTML='';
      onTile(p,board.tiles[p.pos]); updateHUD(); state.rolling=false;
    }
  },260);
}
function rollD8(){ if(state.rolling) return; diceSfx(); const n=rand(1,8); lastRoll.textContent=n; animateMove(n); }
function nextPlayer(){
  if(state.rolling) return;
  state.active=(state.active+1)%state.players.length;
  if(state.active===0){ state.round++; if((state.round-1)%12===0) state.year++; }
  updateHUD(); drawTokens();
}

/* ===== Leaderboard & Timer ===== */
function renderLeaderboard(){
  const list=document.getElementById('leaderList'); const summary=document.getElementById('leaderSummary');
  const arr = state.players.map((p,i)=>({i,name:p.name,total:totals(p),cash:p.cash,save:p.saving,inv:p.portfolio.total}));
  arr.sort((a,b)=>b.total-a.total);
  list.innerHTML='';
  arr.forEach((r,idx)=>{
    const row=document.createElement('div'); row.className='lbRow'+(idx===0?' leader':'');
    row.innerHTML = `
      <div>${idx===0?'üëë':('#'+(idx+1))}</div>
      <div class="lbName">${r.name}</div>
      <div class="lbTotal">${fmtCF(r.total)}</div>
      <div class="lbSub">Kas ${fmtCF(r.cash)} ¬∑ S ${fmtCF(r.save)} ¬∑ I ${fmtCF(r.inv)}</div>
    `;
    list.appendChild(row);
  });
  summary.textContent = arr.length ? `Pemimpin: ${arr.filter(x=>x.total===arr[0].total).map(x=>x.name).join(', ')}` : '';
}
function startTimer(){
  if(_timerInt) return;
  gameStartTs = Date.now();
  document.getElementById('startInfo').textContent = new Date(gameStartTs).toLocaleTimeString('id-ID',{hour12:false});
  _timerInt = setInterval(()=>{
    const el=document.getElementById('gameClock'); const ms = Date.now() - gameStartTs; const s = Math.floor(ms/1000);
    const hh = Math.floor(s/3600).toString().padStart(2,'0'); const mm = Math.floor((s%3600)/60).toString().padStart(2,'0'); const ss = (s%60).toString().padStart(2,'0');
    el.textContent = (hh!=='00') ? `${hh}:${mm}:${ss}` : `${mm}:${ss}`;
  },1000);
}

/* ===== Setup Pemain ===== */
const pModal=document.getElementById('playerModal');
function openPlayerModal(){ pModal.classList.add('show'); buildNameInputs() }
function buildNameInputs(){ const c=+playerCount.value, box=document.getElementById('names'); box.innerHTML=''; for(let i=1;i<=c;i++){ const d=document.createElement('div'); d.innerHTML=`<label class="row"><span class="caps">P${i}:</span> <input id="nm${i}" value="P${i}" style="flex:1;border:1px solid var(--line);border-radius:8px;padding:6px"></label>`; box.appendChild(d) } }
playerCount.addEventListener('change',buildNameInputs);
startBtn.addEventListener('click',()=>{
  const c=+playerCount.value; state.players=[];
  for(let i=1;i<=c;i++){
    state.players.push({
      name:document.getElementById('nm'+i).value||('P'+i),
      pos:START_INDEX, cash:CF(200), income:CF(20), baselineC:CF(board.values.CONSUME||5),
      saving:0, savingBanks:{A:0,B:0,C:0,D:0}, portfolio:{holdings:{},total:0}
    });
  }
  pModal.classList.remove('show');
  buildBoard(); updateHUD(); renderLeaderboard(); log(`Permainan dimulai (${c} pemain). START sama.`); startTimer();
});

/* ===== Kontrol ===== */
rollBtn.onclick=rollD8; endBtn.onclick=nextPlayer; resetBtn.onclick=()=>location.reload();

/* ===== Boot ===== */
function autoStartIfNeeded(){
  if(state.players.length===0){
    state.players=[{name:'P1',pos:START_INDEX,cash:CF(200),income:CF(20),baselineC:CF(board.values.CONSUME||5),saving:0,savingBanks:{A:0,B:0,C:0,D:0},portfolio:{holdings:{},total:0}}];
    buildBoard(); updateHUD(); renderLeaderboard(); openPlayerModal(); startTimer();
  }else{ buildBoard(); updateHUD(); renderLeaderboard(); startTimer(); }
}
autoStartIfNeeded();
</script>
</body>
</html>
